#!/usr/bin/env bash

# Dotfiles Sync Script
# Syncs changes from ~/dotfiles (work repo) to ~/.dotfiles (installed copy)
#
# Usage:
#   dotfiles-sync           # Sync from ~/dotfiles to ~/.dotfiles
#   dotfiles-sync --check   # Check what would be synced without doing it

set -e

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[✓]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[!]${NC} $1"; }
log_error() { echo -e "${RED}[✗]${NC} $1"; }

# Parse arguments
DRY_RUN=false
if [ "$1" = "--check" ] || [ "$1" = "-n" ]; then
    DRY_RUN=true
    log_warn "DRY RUN MODE - No changes will be made"
    echo ""
fi

# Determine locations
DOTFILES_REPO="${DOTFILES_REPO:-${HOME}/dotfiles}"
DOTFILES_INSTALL="${DOTFILES_DIR:-${HOME}/.dotfiles}"

echo -e "${BLUE}Dotfiles Sync${NC}"
echo ""
echo "From: $DOTFILES_REPO (work repo)"
echo "To:   $DOTFILES_INSTALL (installed copy)"
echo ""

# Validate source exists
if [ ! -d "$DOTFILES_REPO" ]; then
    log_error "Work repo not found at $DOTFILES_REPO"
    echo "Set DOTFILES_REPO environment variable or create ~/dotfiles"
    exit 1
fi

if [ ! -d "$DOTFILES_REPO/.git" ]; then
    log_error "$DOTFILES_REPO is not a git repository"
    exit 1
fi

# Validate destination exists
if [ ! -d "$DOTFILES_INSTALL" ]; then
    log_error "Installation directory not found at $DOTFILES_INSTALL"
    echo "Run ./install.sh first to create the installation"
    exit 1
fi

# Check for uncommitted changes in work repo
cd "$DOTFILES_REPO"
if ! git diff-index --quiet HEAD -- 2>/dev/null; then
    log_warn "Work repo has uncommitted changes"
    echo ""
    git status --short
    echo ""

    if $DRY_RUN; then
        log_info "Would sync these uncommitted changes to installation"
    else
        read -p "Sync uncommitted changes to installation? [y/N] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log_info "Sync cancelled. Commit your changes first."
            exit 0
        fi
    fi
fi

# Perform sync
log_info "Syncing files..."

if $DRY_RUN; then
    # Show what would be synced
    rsync -avn --delete \
        --exclude='.git' \
        --exclude='.gitignore' \
        --exclude='.gitattributes' \
        --exclude='README.md' \
        --exclude='LICENSE' \
        --exclude='tutorial.sh' \
        "$DOTFILES_REPO/" "$DOTFILES_INSTALL/"
else
    # Actually sync
    rsync -av --delete \
        --exclude='.git' \
        --exclude='.gitignore' \
        --exclude='.gitattributes' \
        --exclude='README.md' \
        --exclude='LICENSE' \
        --exclude='tutorial.sh' \
        "$DOTFILES_REPO/" "$DOTFILES_INSTALL/"

    log_success "Dotfiles synced successfully"
    echo ""
    log_info "Changes will take effect:"
    log_info "  • Immediately for new shells"
    log_info "  • In existing shells, reload your config:"
    log_info "    - bash: source ~/.bashrc"
    log_info "    - zsh:  source ~/.zshrc"
    log_info "    - fish: source ~/.config/fish/config.fish (or restart shell)"
    echo ""
fi
