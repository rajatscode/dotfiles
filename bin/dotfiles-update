#!/usr/bin/env bash

# Dotfiles Update Script
# Updates dotfiles from git repo

set -e

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[âœ“]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[!]${NC} $1"; }

# Find dotfiles directory
DOTFILES_DIR="${DOTFILES_HOME_DIR:-${HOME}/dotfiles}"

if [ ! -d "$DOTFILES_DIR/.git" ]; then
    DOTFILES_DIR="${HOME}/.config/dotfiles"
    if [ ! -d "$DOTFILES_DIR/.git" ]; then
        echo "Error: Could not find dotfiles git repository"
        echo "Tried: \$DOTFILES_HOME_DIR, ~/dotfiles, ~/.config/dotfiles"
        exit 1
    fi
fi

log_info "Updating dotfiles from: $DOTFILES_DIR"

cd "$DOTFILES_DIR"

# Check for uncommitted changes
if [ -n "$(git status --porcelain)" ]; then
    log_warn "You have uncommitted changes in your dotfiles repo."
    read -p "Stash changes and update? [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        git stash
        stashed=true
    else
        echo "Update cancelled."
        exit 0
    fi
fi

# Pull latest changes
log_info "Pulling latest changes..."
git pull --rebase

# Re-apply stow if needed (optional)
if command -v stow &>/dev/null; then
    log_info "Configs are symlinked, they're already updated!"
else
    log_warn "GNU Stow not found. Install it to manage dotfiles with symlinks."
fi

# Pop stash if we stashed
if [ "${stashed:-false}" = true ]; then
    log_info "Reapplying your changes..."
    git stash pop
fi

log_success "Dotfiles updated successfully!"
log_info "Changes will take effect in new shell sessions."
log_info "Or run: source ~/.bashrc"
