#!/usr/bin/env bash

# Dotfiles Update Script
# Updates dotfiles from git repo
#
# Usage:
#   dotfiles-update           # Update current branch
#   dotfiles-update <branch>  # Switch to and update specific branch

set -e

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[âœ“]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[!]${NC} $1"; }

# Parse arguments
BRANCH="${1:-}"

# Find dotfiles directory
DOTFILES_DIR="${DOTFILES_HOME_DIR:-${HOME}/dotfiles}"

if [ ! -d "$DOTFILES_DIR/.git" ]; then
    DOTFILES_DIR="${HOME}/.config/dotfiles"
    if [ ! -d "$DOTFILES_DIR/.git" ]; then
        echo "Error: Could not find dotfiles git repository"
        echo "Tried: \$DOTFILES_HOME_DIR, ~/dotfiles, ~/.config/dotfiles"
        exit 1
    fi
fi

log_info "Updating dotfiles from: $DOTFILES_DIR"

cd "$DOTFILES_DIR"

# Check for uncommitted changes
if [ -n "$(git status --porcelain)" ]; then
    log_warn "You have uncommitted changes in your dotfiles repo."
    read -p "Stash changes and update? [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        git stash
        stashed=true
    else
        echo "Update cancelled."
        exit 0
    fi
fi

# Pull latest changes
if [ -n "$BRANCH" ]; then
    log_info "Switching to branch: $BRANCH"
    git fetch origin

    # Check if branch exists locally
    if git show-ref --verify --quiet "refs/heads/$BRANCH"; then
        # Branch exists locally, checkout and pull
        git checkout "$BRANCH"
        log_info "Pulling latest changes from $BRANCH..."
        git pull --rebase origin "$BRANCH"
    else
        # Branch doesn't exist locally, create tracking branch
        log_info "Creating local branch tracking origin/$BRANCH..."
        git checkout -b "$BRANCH" "origin/$BRANCH"
    fi
else
    log_info "Pulling latest changes..."
    git pull --rebase
fi

# Re-apply stow if needed (optional)
if command -v stow &>/dev/null; then
    log_info "Configs are symlinked, they're already updated!"
else
    log_warn "GNU Stow not found. Install it to manage dotfiles with symlinks."
fi

# Pop stash if we stashed
if [ "${stashed:-false}" = true ]; then
    log_info "Reapplying your changes..."
    git stash pop
fi

log_success "Dotfiles updated successfully!"
log_info "Changes will take effect in new shell sessions."
log_info "Or run: source ~/.bashrc"
