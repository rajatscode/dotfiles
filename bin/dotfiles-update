#!/usr/bin/env bash

# Dotfiles Update Script
# Updates dotfiles from git repo
#
# Usage:
#   dotfiles-update           # Update current branch
#   dotfiles-update <branch>  # Switch to and update specific branch

set -e

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[✓]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[!]${NC} $1"; }

# Parse arguments
BRANCH="${1:-}"

# Use DOTFILES_DIR if set, otherwise default to ~/.dotfiles (the standard install location)
DOTFILES_DIR="${DOTFILES_DIR:-${HOME}/.dotfiles}"

if [ ! -d "$DOTFILES_DIR/.git" ]; then
    echo "Error: Could not find dotfiles git repository at $DOTFILES_DIR"
    echo "Make sure \$DOTFILES_DIR points to your dotfiles installation"
    exit 1
fi

log_info "Updating dotfiles from: $DOTFILES_DIR"

cd "$DOTFILES_DIR"

# Fetch latest from origin
log_info "Fetching from origin..."
git fetch origin

# Determine target branch
if [ -n "$BRANCH" ]; then
    TARGET_BRANCH="$BRANCH"
else
    # Use current branch
    TARGET_BRANCH="$(git rev-parse --abbrev-ref HEAD)"
fi

log_info "Force resetting to origin/$TARGET_BRANCH..."

# Check if remote branch exists
if ! git rev-parse --verify "origin/$TARGET_BRANCH" &>/dev/null; then
    echo "Error: Branch origin/$TARGET_BRANCH does not exist"
    exit 1
fi

# Force reset to match remote exactly (no merge conflicts possible)
git reset --hard "origin/$TARGET_BRANCH"

# Checkout the branch if we're switching
if [ -n "$BRANCH" ] && [ "$(git rev-parse --abbrev-ref HEAD)" != "$BRANCH" ]; then
    if git show-ref --verify --quiet "refs/heads/$BRANCH"; then
        git checkout "$BRANCH"
    else
        log_info "Creating local branch $BRANCH tracking origin/$BRANCH..."
        git checkout -b "$BRANCH" "origin/$BRANCH"
    fi
    # Reset again to ensure we're exactly on the remote
    git reset --hard "origin/$BRANCH"
fi

# Check for yq (needed for agent template system)
if ! command -v yq &>/dev/null; then
    log_warn "yq (YAML processor) not found. Agent templates may not work correctly."
    log_info "Install yq: brew install yq (macOS) or apt install yq (Ubuntu) or pacman -S yq (Arch)"
fi

# Install/update system packages
log_info "Installing/updating system packages..."
case "$(uname)" in
    Linux)
        if command -v apt-get &>/dev/null; then
            # Debian/Ubuntu
            if [ -f "$DOTFILES_DIR/linux/packages-apt.txt" ]; then
                log_info "Installing packages from packages-apt.txt..."
                # apt-get install will skip already-installed packages
                if grep -v "^#" "$DOTFILES_DIR/linux/packages-apt.txt" | grep -v "^$" | xargs sudo apt-get install -y 2>&1; then
                    log_success "Packages updated (apt)"
                else
                    log_warn "Some packages failed to install (apt)"
                fi
            fi
        elif command -v pacman &>/dev/null; then
            # Arch Linux
            if [ -f "$DOTFILES_DIR/linux/packages-pacman.txt" ]; then
                log_info "Installing packages from packages-pacman.txt..."
                # --needed flag skips already-installed packages
                if grep -v "^#" "$DOTFILES_DIR/linux/packages-pacman.txt" | grep -v "^$" | xargs sudo pacman -S --noconfirm --needed 2>&1; then
                    log_success "Packages updated (pacman)"
                else
                    log_warn "Some packages failed to install (pacman)"
                fi
            fi
        else
            log_warn "No supported package manager found (apt/pacman)"
        fi
        ;;
    Darwin)
        # macOS
        if command -v brew &>/dev/null; then
            if [ -f "$DOTFILES_DIR/macos/Brewfile" ]; then
                log_info "Installing packages from Brewfile..."
                if brew bundle --file="$DOTFILES_DIR/macos/Brewfile" 2>&1; then
                    log_success "Packages updated (brew)"
                else
                    log_warn "Some packages failed to install (brew)"
                fi
            fi
        else
            log_warn "Homebrew not found"
        fi
        ;;
esac

# Install Python packages needed by Vim plugins
# These need to be importable Python modules, not just CLI tools
log_info "Installing Python tools for Vim..."
if command -v python3 &>/dev/null; then
    # Determine pip flags based on OS
    case "$(uname)" in
        Darwin)
            # macOS: Python 3.14+ is externally-managed, need --break-system-packages
            PIP_FLAGS="--user --break-system-packages --upgrade --quiet"
            ;;
        Linux)
            # Linux: Try --user first, fall back to --break-system-packages if needed
            PIP_FLAGS="--user --upgrade --quiet"
            ;;
        *)
            PIP_FLAGS="--user --upgrade --quiet"
            ;;
    esac

    # Install isort for vim-isort plugin
    if python3 -m pip install $PIP_FLAGS isort 2>&1 | grep -q "externally-managed-environment"; then
        # If externally-managed error, retry with --break-system-packages
        log_info "Retrying with --break-system-packages flag..."
        if python3 -m pip install --user --break-system-packages --upgrade --quiet isort 2>&1; then
            log_success "Python tools installed (isort)"
        else
            log_warn "Failed to install isort via pip"
        fi
    elif python3 -c "import isort" 2>/dev/null; then
        log_success "Python tools installed (isort)"
    else
        log_warn "Failed to install isort via pip"
    fi
else
    log_warn "python3 not found - skipping Python tools installation"
fi

# Update Vim plugins if Vundle is installed
if [ -f "$HOME/.vimrc" ] && [ -d "$HOME/.vim/bundle/Vundle.vim" ]; then
    log_info "Installing/updating Vim plugins..."
    if vim +PluginInstall +qall 2>&1; then
        log_success "Vim plugins updated"

        # Compile YouCompleteMe if it was just installed/updated
        if [ -d "$HOME/.vim/bundle/YouCompleteMe" ] && [ -f "$HOME/.vim/bundle/YouCompleteMe/install.py" ]; then
            # Check if already compiled
            if compgen -G "$HOME/.vim/bundle/YouCompleteMe/third_party/ycmd/ycm_core*.so" > /dev/null; then
                log_info "YouCompleteMe already compiled, skipping"
            elif ! command -v cmake >/dev/null 2>&1; then
                log_warn "cmake not found - skipping YouCompleteMe compilation"
                log_info "Install cmake: brew install cmake (macOS) or apt install cmake (Linux)"
            else
                log_info "Compiling YouCompleteMe..."
                # Use --ts-completer --clangd-completer instead of --all (Go support is broken)
                if (cd "$HOME/.vim/bundle/YouCompleteMe" && python3 install.py --ts-completer --clangd-completer 2>&1); then
                    log_success "YouCompleteMe compiled successfully"
                else
                    log_warn "YouCompleteMe compilation failed - you may need to run it manually"
                fi
            fi
        fi
    else
        log_warn "Failed to update Vim plugins"
    fi
fi

log_success "Dotfiles updated successfully to $TARGET_BRANCH!"
log_info ""
log_info "Changes will take effect:"
log_info "  • Immediately for new shells"
log_info "  • In existing shells, reload your config:"
log_info "    - bash: source ~/.bashrc"
log_info "    - zsh:  source ~/.zshrc"
log_info "    - fish: source ~/.config/fish/config.fish (or restart shell)"
log_info ""
