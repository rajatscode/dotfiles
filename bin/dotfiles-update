#!/usr/bin/env bash

# Dotfiles Update Script
# Updates dotfiles from git repo
#
# Usage:
#   dotfiles-update           # Update current branch
#   dotfiles-update <branch>  # Switch to and update specific branch

set -e

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[âœ“]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[!]${NC} $1"; }

# Parse arguments
BRANCH="${1:-}"

# Use DOTFILES_DIR if set, otherwise default to ~/.dotfiles (the standard install location)
DOTFILES_DIR="${DOTFILES_DIR:-${HOME}/.dotfiles}"

if [ ! -d "$DOTFILES_DIR/.git" ]; then
    echo "Error: Could not find dotfiles git repository at $DOTFILES_DIR"
    echo "Make sure \$DOTFILES_DIR points to your dotfiles installation"
    exit 1
fi

log_info "Updating dotfiles from: $DOTFILES_DIR"

cd "$DOTFILES_DIR"

# Fetch latest from origin
log_info "Fetching from origin..."
git fetch origin

# Determine target branch
if [ -n "$BRANCH" ]; then
    TARGET_BRANCH="$BRANCH"
else
    # Use current branch
    TARGET_BRANCH="$(git rev-parse --abbrev-ref HEAD)"
fi

log_info "Force resetting to origin/$TARGET_BRANCH..."

# Check if remote branch exists
if ! git rev-parse --verify "origin/$TARGET_BRANCH" &>/dev/null; then
    echo "Error: Branch origin/$TARGET_BRANCH does not exist"
    exit 1
fi

# Force reset to match remote exactly (no merge conflicts possible)
git reset --hard "origin/$TARGET_BRANCH"

# Checkout the branch if we're switching
if [ -n "$BRANCH" ] && [ "$(git rev-parse --abbrev-ref HEAD)" != "$BRANCH" ]; then
    if git show-ref --verify --quiet "refs/heads/$BRANCH"; then
        git checkout "$BRANCH"
    else
        log_info "Creating local branch $BRANCH tracking origin/$BRANCH..."
        git checkout -b "$BRANCH" "origin/$BRANCH"
    fi
    # Reset again to ensure we're exactly on the remote
    git reset --hard "origin/$BRANCH"
fi

# Re-apply stow if needed (optional)
if command -v stow &>/dev/null; then
    log_info "Configs are symlinked, they're already updated!"
else
    log_warn "GNU Stow not found. Install it to manage dotfiles with symlinks."
fi

# Check for yq (needed for agent template system)
if ! command -v yq &>/dev/null; then
    log_warn "yq (YAML processor) not found. Agent templates may not work correctly."
    log_info "Install yq: brew install yq (macOS) or apt install yq (Ubuntu) or pacman -S yq (Arch)"
fi

# Update Vim plugins if Vundle is installed
if [ -f "$HOME/.vimrc" ] && [ -d "$HOME/.vim/bundle/Vundle.vim" ]; then
    log_info "Installing/updating Vim plugins..."
    if vim +PluginInstall +qall 2>&1; then
        log_success "Vim plugins updated"

        # Compile YouCompleteMe if it was just installed/updated
        if [ -d "$HOME/.vim/bundle/YouCompleteMe" ] && [ -f "$HOME/.vim/bundle/YouCompleteMe/install.py" ]; then
            if ! command -v cmake >/dev/null 2>&1; then
                log_warn "cmake not found - skipping YouCompleteMe compilation"
                log_info "Install cmake: brew install cmake (macOS) or apt install cmake (Linux)"
            else
                log_info "Compiling YouCompleteMe..."
                # Use --ts-completer --clangd-completer instead of --all (Go support is broken)
                if (cd "$HOME/.vim/bundle/YouCompleteMe" && python3 install.py --ts-completer --clangd-completer 2>&1); then
                    log_success "YouCompleteMe compiled successfully"
                else
                    log_warn "YouCompleteMe compilation failed - you may need to run it manually"
                fi
            fi
        fi
    else
        log_warn "Failed to update Vim plugins"
    fi
fi

log_success "Dotfiles updated successfully to $TARGET_BRANCH!"
log_info "Changes will take effect in new shell sessions."
log_info "Or run: source ~/.bashrc"
