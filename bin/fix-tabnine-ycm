#!/usr/bin/env bash

# Fix TabNine YCM compatibility with Python 3.10+
# Python 3.10 moved collections.Mapping to collections.abc.Mapping

set -euo pipefail

TABNINE_DIR="${HOME}/.vim/bundle/tabnine-vim"

if [[ ! -d "$TABNINE_DIR" ]]; then
    echo "TabNine directory not found at: $TABNINE_DIR"
    exit 1
fi

echo "Fixing TabNine YCM compatibility with Python 3.10+..."

# Find all Python files with the old import
files_to_fix=$(find "$TABNINE_DIR/third_party/ycmd" -name "*.py" -type f -exec grep -l "from collections import.*Mapping" {} \; 2>/dev/null || true)

if [[ -z "$files_to_fix" ]]; then
    echo "No files found with old collections.Mapping import. Already fixed or different issue."
    exit 0
fi

echo "Found files to fix:"
echo "$files_to_fix"
echo ""

# Backup and patch each file
for file in $files_to_fix; do
    echo "Patching: $file"
    # Create backup
    cp "$file" "$file.bak"

    # Replace the import
    sed -i '' 's/from collections import \(.*\)Mapping/from collections.abc import \1Mapping/g' "$file"
done

echo ""
echo "âœ“ Fixed! Original files backed up with .bak extension"
echo ""
echo "If you encounter issues, restore backups with:"
echo "  find $TABNINE_DIR -name '*.bak' -execdir sh -c 'mv \"\$0\" \"\${0%.bak}\"' {} \;"
