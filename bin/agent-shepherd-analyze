#!/usr/bin/env bash

# agent-shepherd-analyze - Analyze PR review comments and suggest actions
#
# This script analyzes a PR review comment, investigates the relevant code,
# and suggests actionable fixes or responses using your configured AI tool.

set -euo pipefail

# Colors
RED=$'\033[0;31m'
GREEN=$'\033[0;32m'
YELLOW=$'\033[1;33m'
BLUE=$'\033[0;34m'
MAGENTA=$'\033[0;35m'
CYAN=$'\033[0;36m'
BOLD=$'\033[1m'
NC=$'\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1" >&2; }
log_step() { echo -e "${CYAN}▶${NC} $1"; }
die() { log_error "$1"; exit 1; }

# Configuration
AGENT_CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/agents"
AGENT_CONFIG_FILE="$AGENT_CONFIG_DIR/config.yaml"

# Get config value from YAML (simple parser)
get_config_value() {
    local key="$1"
    local default="${2:-}"

    if [[ ! -f "$AGENT_CONFIG_FILE" ]]; then
        echo "$default"
        return
    fi

    local value=$(grep "^${key//./ }: " "$AGENT_CONFIG_FILE" 2>/dev/null | sed 's/^[^:]*: *//' | tr -d '"')

    if [[ -z "$value" ]]; then
        echo "$default"
    else
        echo "$value"
    fi
}

# Parse arguments
comment_file=""
pr_number=""
auto_apply=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --comment=*)
            comment_file="${1#*=}"
            shift
            ;;
        --pr=*)
            pr_number="${1#*=}"
            shift
            ;;
        --auto-apply)
            auto_apply=true
            shift
            ;;
        *)
            die "Unknown argument: $1"
            ;;
    esac
done

[[ -z "$comment_file" ]] && die "Missing --comment argument"
[[ -z "$pr_number" ]] && die "Missing --pr argument"
[[ ! -f "$comment_file" ]] && die "Comment file not found: $comment_file"

# Read comment details
comment_id=$(jq -r '.id' "$comment_file")
comment_path=$(jq -r '.path' "$comment_file")
comment_line=$(jq -r '.line' "$comment_file")
comment_body=$(jq -r '.body' "$comment_file")
comment_user=$(jq -r '.user' "$comment_file")
diff_hunk=$(jq -r '.diff_hunk' "$comment_file")

log_step "Analyzing comment from $comment_user on $comment_path:$comment_line"
echo ""

# Get file context (surrounding lines)
context_lines=20
if [[ -f "$comment_path" ]]; then
    start_line=$((comment_line > context_lines ? comment_line - context_lines : 1))
    end_line=$((comment_line + context_lines))

    log_info "Reading file context (lines $start_line-$end_line)..."
    file_context=$(sed -n "${start_line},${end_line}p" "$comment_path" | cat -n)
else
    log_warn "File not found in current working directory: $comment_path"
    file_context="[File not found - it may have been renamed or deleted]"
fi

# Create analysis prompt
analysis_prompt=$(cat <<EOF
# PR Review Comment Analysis

## Comment Details
- **File**: $comment_path:$comment_line
- **Author**: $comment_user
- **PR**: #$pr_number

## Review Comment
$comment_body

## Diff Context
\`\`\`diff
$diff_hunk
\`\`\`

## File Context (±$context_lines lines)
\`\`\`
$file_context
\`\`\`

## Your Task

Analyze this PR review comment and provide:

1. **Summary**: What is the reviewer asking for?
2. **Assessment**: Is this comment valid? What's the current state of the code?
3. **Suggested Action**: What should be done? Choose one:
   - FIX: Make a specific code change
   - CLARIFY: The comment needs clarification from the reviewer
   - ACKNOWLEDGE: Comment is noted but no action needed
   - DEFER: This should be addressed in a future PR
   - DISAGREE: Respectfully disagree with the comment

4. **Implementation**: If action is FIX, provide:
   - Exact code changes needed
   - Any tests that should be updated
   - Any documentation updates

5. **Response**: Draft a reply to post on the PR comment

Format your response as:
\`\`\`yaml
summary: |
  [Brief summary of the comment]
assessment: |
  [Your assessment of the current code and comment validity]
action: [FIX|CLARIFY|ACKNOWLEDGE|DEFER|DISAGREE]
confidence: [HIGH|MEDIUM|LOW]
implementation:
  changes: |
    [Specific code changes, if action is FIX]
  tests: |
    [Test updates needed, if any]
  docs: |
    [Documentation updates, if any]
response: |
  [Draft reply to post on the PR]
\`\`\`
EOF
)

# Save analysis prompt to temp file
analysis_file="/tmp/shepherd-analysis-$$.md"
echo "$analysis_prompt" > "$analysis_file"

echo -e "${BOLD}Analysis Prompt:${NC}"
echo "────────────────────────────────────────────────────"
cat "$analysis_file"
echo "────────────────────────────────────────────────────"
echo ""

# Read AI tool configuration
ai_command=$(get_config_value 'ai_tool.command')
context_method=$(get_config_value 'ai_tool.context_method' 'manual')
context_flag=$(get_config_value 'ai_tool.context_flag' '--context')
context_env=$(get_config_value 'ai_tool.context_env' 'AGENT_CONTEXT')

# Check if AI tool is configured
if [[ -z "$ai_command" ]]; then
    log_warn "AI tool not configured. Run: ${GREEN}agent config${NC}"
    echo ""
    log_info "Analysis prompt saved to: $analysis_file"
    echo ""
    echo -e "${BOLD}To analyze this comment:${NC}"
    echo "  1. Copy the prompt above"
    echo "  2. Paste into your AI tool"
    echo "  3. Review the suggested action and apply changes manually"
    echo ""
    echo "For automatic analysis, run: ${GREEN}agent config${NC}"
    exit 0
fi

log_info "Using configured AI tool: $ai_command"
echo ""

# Prepare AI command based on context method
ai_cmd="$ai_command"

case "$context_method" in
    flag)
        ai_cmd="$ai_command $context_flag \"$analysis_file\""
        ;;
    env)
        export "$context_env=$analysis_file"
        log_info "Set $context_env=$analysis_file"
        ;;
    clipboard)
        if command -v pbcopy >/dev/null 2>&1; then
            cat "$analysis_file" | pbcopy
            log_info "Analysis prompt copied to clipboard (pbcopy)"
        elif command -v xclip >/dev/null 2>&1; then
            cat "$analysis_file" | xclip -selection clipboard
            log_info "Analysis prompt copied to clipboard (xclip)"
        elif command -v wl-copy >/dev/null 2>&1; then
            cat "$analysis_file" | wl-copy
            log_info "Analysis prompt copied to clipboard (wl-copy)"
        else
            log_warn "No clipboard tool found"
        fi
        log_info "Paste the prompt into $ai_command and review the suggestions"
        exit 0
        ;;
    file)
        ln -sf "$analysis_file" ./.shepherd-prompt
        log_info "Created .shepherd-prompt symlink"
        ;;
    manual)
        log_info "Manual mode - analysis prompt saved to: $analysis_file"
        echo ""
        echo -e "${BOLD}Next steps:${NC}"
        echo "  1. Copy the prompt above"
        echo "  2. Paste into your AI tool"
        echo "  3. Review the suggested action"
        echo "  4. Apply changes manually if needed"
        exit 0
        ;;
esac

# Execute AI tool
log_info "Executing: $ai_cmd"
echo ""

ai_output=$(eval "$ai_cmd" 2>&1) || {
    log_warn "AI tool execution failed"
    log_info "You can manually use the prompt at: $analysis_file"
    exit 0
}

# Display output
if [[ -n "$ai_output" ]]; then
    echo "$ai_output"
    echo ""

    # Try to parse structured response (YAML format)
    action=$(echo "$ai_output" | grep "^action:" | cut -d' ' -f2- | tr -d ' ' | head -1)
    confidence=$(echo "$ai_output" | grep "^confidence:" | cut -d' ' -f2- | tr -d ' ' | head -1)

    if [[ -n "$action" ]]; then
        log_info "Suggested Action: ${BOLD}$action${NC} (Confidence: ${confidence:-UNKNOWN})"
        echo ""

        # If action is FIX and confidence is HIGH/MEDIUM, offer to apply
        if [[ "$action" == "FIX" ]]; then
            log_warn "Automatic fix application not yet implemented."
            log_info "Please review the suggested changes above and apply manually."
            log_info "File: $comment_path:$comment_line"
            echo ""
        fi

        # Check for response to post
        response=$(echo "$ai_output" | sed -n '/^response:/,/^$/p' | tail -n +2)
        if [[ -n "$response" ]] && ! $auto_apply; then
            echo -e "${BOLD}Suggested Response:${NC}"
            echo "$response"
            echo ""

            read -p "Post this response to the PR comment? [y/N] " post_response </dev/tty
            if [[ "$post_response" =~ ^[Yy]$ ]]; then
                echo "$response" | gh pr comment "$pr_number" --body-file - && \
                    log_success "Response posted!" || \
                    log_error "Failed to post response"
            fi
        fi
    fi
fi

# Cleanup
rm -f "$analysis_file"

log_success "Analysis complete"
